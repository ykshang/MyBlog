---
title: 2. å¦‚ä½•åœ¨ ESM é‡Œä½¿ç”¨ CJS çš„åŒ…
createTime: 2025/06/24 12:24:03
permalink: /NodeJs/dz532cqn/
---

åœ¨ **ES Modules (ESM)** ä¸­å¼•å…¥ **CommonJS (CJS)** çš„åŒ…ï¼Œéœ€è¦æ ¹æ®ä¸åŒçš„è¿è¡Œç¯å¢ƒï¼ˆNode.js / æµè§ˆå™¨ / æ‰“åŒ…å·¥å…·ï¼‰å’Œæ¨¡å—ç³»ç»Ÿè¿›è¡Œé€‚é…ã€‚ä»¥ä¸‹æ˜¯è¯¦ç»†è§£å†³æ–¹æ¡ˆï¼š

## Node.js ç¯å¢ƒä¸‹çš„ ESM å¼•å…¥ CJS

Node.js æ”¯æŒåœ¨ ESM ä¸­ç›´æ¥ `import` CommonJS æ¨¡å—ï¼Œä½†éœ€æ³¨æ„ï¼š

### 1ã€ç›´æ¥ `import`ï¼ˆæ¨èï¼‰

```javascript
// ESM æ–‡ä»¶ï¼ˆå¦‚ app.mjs æˆ– package.json è®¾ç½® "type": "module"ï¼‰
import cjsPackage from "commonjs-package"; // é»˜è®¤å¯¼å…¥
import { namedExport } from "commonjs-package"; // å…·åå¯¼å…¥ï¼ˆå¦‚æœ CJS æ”¯æŒï¼‰
```

**æ³¨æ„äº‹é¡¹**ï¼š

- å¦‚æœ CJS æ¨¡å—ä½¿ç”¨ `module.exports = ...`ï¼Œéœ€ç”¨ `default` å¯¼å…¥ï¼š

  ```javascript
  import cjsDefault from "commonjs-package"; // å¯¹åº” module.exports = ...
  ```

- å¦‚æœ CJS æ¨¡å—å¯¼å‡ºå¤šä¸ªå±æ€§ï¼ˆå¦‚ `exports.a = ...; exports.b = ...`ï¼‰ï¼Œå¯ä»¥ç”¨ï¼š

  ```javascript
  import * as cjsModule from "commonjs-package"; // å…¨éƒ¨å¯¼å…¥ä¸ºå‘½åç©ºé—´
  console.log(cjsModule.a, cjsModule.b);
  ```

### 2ã€åŠ¨æ€ `import()`ï¼ˆå¼‚æ­¥åŠ è½½ï¼‰

```javascript
const cjsModule = await import("commonjs-package"); // è¿”å› Promise
console.log(cjsModule.default); // å¯¹åº” module.exports
```

### 3ã€ä½¿ç”¨ `createRequire`ï¼ˆå…¼å®¹å¤æ‚åœºæ™¯ï¼‰

å¦‚æœé‡åˆ°å…¼å®¹æ€§é—®é¢˜ï¼Œå¯ä»¥ä½¿ç”¨ `node:module` æ‰‹åŠ¨åˆ›å»º `require`ï¼š

```javascript
import { createRequire } from "node:module";
const require = createRequire(import.meta.url);

const cjsModule = require("commonjs-package"); // ä¼ ç»Ÿ require
```

## æµè§ˆå™¨ç¯å¢ƒï¼ˆé€šè¿‡æ‰“åŒ…å·¥å…·ï¼‰

åœ¨æµè§ˆå™¨ä¸­è¿è¡Œ ESM æ—¶ï¼Œéœ€å€ŸåŠ© **Webpack / Vite / Rollup** ç­‰å·¥å…·å¤„ç† CJS ä¾èµ–ï¼š

### 1ã€Webpack / Vite / Rollup

è¿™äº›å·¥å…·ä¼šè‡ªåŠ¨è½¬æ¢ CJS ä¸º ESMï¼Œæ— éœ€é¢å¤–é…ç½®ï¼š

```javascript
// ç›´æ¥ importï¼Œæ‰“åŒ…å·¥å…·ä¼šå¤„ç†
import cjsPackage from "commonjs-package";
```

### 2ã€æµè§ˆå™¨åŸç”Ÿ ESM + CDN

å¦‚æœç›´æ¥ä½¿ç”¨æµè§ˆå™¨ ESMï¼ˆæ— æ‰“åŒ…å·¥å…·ï¼‰ï¼Œéœ€ç¡®ä¿ CJS åŒ…æä¾› ESM ç‰ˆæœ¬ï¼ˆå¦‚é€šè¿‡ `esm.sh` æˆ– `skypack.dev`ï¼‰ï¼š

```html
<script type="module">
  import lodash from "https://esm.sh/lodash"; // CDN æä¾› ESM ç‰ˆæœ¬
  console.log(lodash.get({ a: 1 }, "a"));
</script>
```

## TypeScript é¡¹ç›®ä¸­çš„ CJS å¯¼å…¥

å¦‚æœä½¿ç”¨ TypeScriptï¼Œéœ€ç¡®ä¿ `tsconfig.json` æ­£ç¡®é…ç½®ï¼š

```json
{
  "compilerOptions": {
    "module": "ESNext", // æˆ– "CommonJS"ï¼ˆå¦‚æœè¾“å‡º CJSï¼‰
    "moduleResolution": "node16", // æˆ– "nodenext"ï¼ˆæ”¯æŒ node: å’Œ CJS äº’æ“ä½œï¼‰
    "esModuleInterop": true, // å…è®¸ default å¯¼å…¥ CJS
    "allowSyntheticDefaultImports": true // å…¼å®¹æ—  default å¯¼å‡ºçš„ CJS æ¨¡å—
  }
}
```

ç„¶åå¯ä»¥æ­£å¸¸ `import`ï¼š

```typescript
import _ from "lodash"; // å³ä½¿ lodash æ˜¯ CJSï¼Œä¹Ÿèƒ½æ­£ç¡®å¯¼å…¥
```

## å¸¸è§é—®é¢˜åŠè§£å†³

### é—®é¢˜ 1ï¼š`__dirname` å’Œ `__filename` åœ¨ ESM ä¸­ä¸å¯ç”¨

```javascript
import { fileURLToPath } from "node:url";
import { dirname } from "node:path";

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);
```

### é—®é¢˜ 2ï¼šCJS åŒ…æ²¡æœ‰é»˜è®¤å¯¼å‡º

```javascript
import * as cjsModule from "commonjs-package"; // å…¨éƒ¨å¯¼å…¥
const { namedExport } = cjsModule; // è§£æ„
```

### é—®é¢˜ 3ï¼šå¾ªç¯ä¾èµ–å¯¼è‡´ `undefined`

- CJS å’Œ ESM æ··ç”¨æ—¶å¯èƒ½å‡ºé—®é¢˜ï¼Œå°½é‡ç»Ÿä¸€æ¨¡å—ç³»ç»Ÿã€‚
- ä½¿ç”¨åŠ¨æ€ `import()` å»¶è¿ŸåŠ è½½ã€‚

## æ€»ç»“

| **åœºæ™¯**        | **æ¨èæ–¹æ¡ˆ**                       |
| --------------- | ---------------------------------- |
| Node.js ESM | ç›´æ¥ `import` æˆ– `createRequire`   |
| æµè§ˆå™¨ ESM  | æ‰“åŒ…å·¥å…·ï¼ˆWebpack/Viteï¼‰æˆ– ESM CDN |
| TypeScript  | é…ç½® `esModuleInterop: true`       |
| åŠ¨æ€åŠ è½½    | `await import('cjs-package')`      |

**æœ€ä½³å®è·µ**ï¼š

- **æ–°é¡¹ç›®**ï¼šå°½é‡ä½¿ç”¨ ESM è§„èŒƒçš„åŒ…ã€‚
- **æ—§é¡¹ç›®è¿ç§»**ï¼šé€æ­¥æ›¿æ¢ CJS ä¾èµ–ï¼Œæˆ–ç”¨ `createRequire` è¿‡æ¸¡ã€‚
- **æµè§ˆå™¨ç¯å¢ƒ**ï¼šä¼˜å…ˆé€‰æ‹© ESM CDN æˆ–æ‰“åŒ…å·¥å…·ã€‚

è¿™æ ·å°±èƒ½åœ¨ ESM ä¸­æ— ç¼ä½¿ç”¨ CJS åŒ…ï¼ ğŸš€
