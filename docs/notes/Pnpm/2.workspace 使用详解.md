---
title: 2. workspace ä½¿ç”¨è¯¦è§£
createTime: 2025/06/14 10:58:49
permalink: /notes/Pnpm/fjvdfhim/
---

**pnpm workspace** æ˜¯ pnpm æä¾›çš„ **Monorepoï¼ˆå•ä½“ä»“åº“ï¼‰** ç®¡ç†æ–¹æ¡ˆï¼Œå…è®¸åœ¨å•ä¸ªä»£ç ä»“åº“ä¸­ç®¡ç†å¤šä¸ªé¡¹ç›®ï¼ˆåŒ…ï¼‰ï¼Œå¹¶é«˜æ•ˆå…±äº«ä¾èµ–ã€‚ç›¸æ¯” `npm/yarn workspace`ï¼Œpnpm é€šè¿‡**ç¡¬é“¾æ¥**èŠ‚çœç£ç›˜ç©ºé—´ï¼Œä¾èµ–ç®¡ç†æ›´é«˜æ•ˆã€‚

## ä¸€ã€æ ¸å¿ƒæ¦‚å¿µ

- **Workspaceï¼ˆå·¥ä½œåŒºï¼‰**ï¼šä¸€ä¸ªåŒ…å«å¤šä¸ªå­é¡¹ç›®çš„æ ¹ç›®å½•ï¼Œé€šè¿‡ `pnpm-workspace.yaml` å®šä¹‰ã€‚
- **å…±äº«ä¾èµ–**ï¼šæ‰€æœ‰å­é¡¹ç›®å…±ç”¨ `node_modules`ï¼Œé¿å…é‡å¤å®‰è£…ã€‚
- **ä¾èµ–æå‡**ï¼šå°†å…±ç”¨çš„ä¾èµ–æå‡åˆ°æ ¹ç›®å½•çš„ `node_modules`ï¼Œå‡å°‘å†—ä½™ã€‚

## äºŒã€åˆå§‹åŒ– Workspace

### **æ­¥éª¤ 1ï¼šåˆ›å»ºé¡¹ç›®ç»“æ„**

```bash
mkdir my-monorepo && cd my-monorepo
pnpm init              # åˆå§‹åŒ–æ ¹ç›®å½• package.json
```

ç›®å½•ç»“æ„ç¤ºä¾‹ï¼š

```
my-monorepo/
â”œâ”€â”€ packages/
â”‚   â”œâ”€â”€ app/           # å­é¡¹ç›®1ï¼ˆå¦‚å‰ç«¯åº”ç”¨ï¼‰
â”‚   â”‚   â””â”€â”€ package.json
â”‚   â””â”€â”€ utils/         # å­é¡¹ç›®2ï¼ˆå¦‚å…±äº«å·¥å…·åº“ï¼‰
â”‚       â””â”€â”€ package.json
â”œâ”€â”€ pnpm-workspace.yaml
â””â”€â”€ package.json
```

### **æ­¥éª¤ 2ï¼šé…ç½® `pnpm-workspace.yaml`**

åœ¨æ ¹ç›®å½•åˆ›å»º `pnpm-workspace.yaml`ï¼Œå®šä¹‰å­é¡¹ç›®è·¯å¾„ï¼š

```yaml
packages:
  - "packages/*" # åŒ¹é… packages/ ä¸‹çš„æ‰€æœ‰é¡¹ç›®
  - "apps/*" # ä¹Ÿå¯ä»¥åŒ¹é…å…¶ä»–ç›®å½•
```

### **æ­¥éª¤ 3ï¼šè®¾ç½®å­é¡¹ç›®**

åœ¨æ¯ä¸ªå­é¡¹ç›®ï¼ˆå¦‚ `packages/utils`ï¼‰ä¸­åˆå§‹åŒ– `package.json`ï¼š

```bash
cd packages/utils
pnpm init
```

ç¡®ä¿ `name` ç¬¦åˆåŒ…å‘½åè§„èŒƒï¼ˆå¦‚ `@my-monorepo/utils`ï¼‰ã€‚

---

## **3. å®‰è£…ä¾èµ–**

### **(1) å…¨å±€å®‰è£…ï¼ˆæ ¹ç›®å½•ï¼‰**

```bash
# å®‰è£…æ‰€æœ‰å­é¡¹ç›®çš„ä¾èµ–ï¼ˆç±»ä¼¼ `npm install`ï¼‰
pnpm install

# å®‰è£…å…¨å±€å·¥å…·ï¼ˆå¦‚ typescriptã€eslintï¼‰
pnpm add -Dw typescript eslint
```

- `-D`ï¼šå¼€å‘ä¾èµ–ï¼ˆ`devDependencies`ï¼‰
- `-w`ï¼šå®‰è£…åœ¨**æ ¹ç›®å½•**ï¼ˆworkspace rootï¼‰

### **(2) ä¸ºå­é¡¹ç›®å•ç‹¬å®‰è£…**

```bash
# è¿›å…¥å­é¡¹ç›®ç›®å½•å®‰è£…
cd packages/app
pnpm add react

# æˆ–ç›´æ¥ä»æ ¹ç›®å½•å®‰è£…ï¼ˆæŒ‡å®šå­é¡¹ç›®ï¼‰
pnpm add react --filter @my-monorepo/app
```

- `--filter`ï¼šæŒ‡å®šç›®æ ‡å­é¡¹ç›®ï¼ˆæ”¯æŒé€šé…ç¬¦ï¼Œå¦‚ `--filter "packages/*"`ï¼‰

### **(3) å­é¡¹ç›®ä¹‹é—´äº’ç›¸å¼•ç”¨**

```bash
# åœ¨ packages/app ä¸­å¼•ç”¨ packages/utils
pnpm add @my-monorepo/utils --filter @my-monorepo/app
```

è¿™ä¼šåœ¨ `app/package.json` ä¸­æ·»åŠ ï¼š

```json
{
  "dependencies": {
    "@my-monorepo/utils": "workspace:*"
  }
}
```

---

## **4. è¿è¡Œè„šæœ¬**

### **(1) è¿è¡Œå•ä¸ªå­é¡¹ç›®çš„è„šæœ¬**

```bash
# è¿›å…¥å­é¡¹ç›®è¿è¡Œ
cd packages/app
pnpm dev

# æˆ–ä»æ ¹ç›®å½•è¿è¡Œï¼ˆæ¨èï¼‰
pnpm --filter @my-monorepo/app dev
```

### **(2) å¹¶è¡Œè¿è¡Œæ‰€æœ‰å­é¡¹ç›®çš„è„šæœ¬**

```bash
pnpm -r run build     # åœ¨æ‰€æœ‰å­é¡¹ç›®ä¸­è¿è¡Œ build å‘½ä»¤
```

- `-r`ï¼šé€’å½’æ‰§è¡Œï¼ˆ`--recursive`ï¼‰

### **(3) ä»…è¿è¡Œéƒ¨åˆ†å­é¡¹ç›®çš„è„šæœ¬**

```bash
pnpm --filter "@my-monorepo/app" run dev
pnpm --filter "{packages/*,apps/*}" run test
```

---

## **5. ä¾èµ–ç®¡ç†ä¼˜åŒ–**

### **(1) æå‡å…¬å…±ä¾èµ–**

é»˜è®¤æƒ…å†µä¸‹ï¼Œpnpm ä¼šè‡ªåŠ¨å°†å…¬å…±ä¾èµ–æå‡åˆ°æ ¹ç›®å½• `node_modules`ï¼Œå‡å°‘é‡å¤å®‰è£…ã€‚

### **(2) ç¦æ­¢ä¾èµ–æå‡**

åœ¨ `pnpm-workspace.yaml` ä¸­è®¾ç½®ï¼š

```yaml
shared-workspace-lockfile: false
```

### **(3) æŸ¥çœ‹ä¾èµ–æ ‘**

```bash
pnpm why lodash       # æŸ¥çœ‹ lodash è¢«å“ªäº›åŒ…ä¾èµ–
pnpm list -r          # é€’å½’åˆ—å‡ºæ‰€æœ‰å­é¡¹ç›®çš„ä¾èµ–
```

---

## **6. å‘å¸ƒ Workspace åŒ…**

### **(1) ç‰ˆæœ¬ç®¡ç†**

ä½¿ç”¨ `changesets` æˆ– `pnpm version` ç®¡ç†ç‰ˆæœ¬å·ï¼š

```bash
# æ›´æ–°æ‰€æœ‰å­é¡¹ç›®ç‰ˆæœ¬
pnpm version patch -r
```

### **(2) å‘å¸ƒåˆ° npm**

```bash
pnpm -r publish       # é€’å½’å‘å¸ƒæ‰€æœ‰åŒ…ï¼ˆéœ€æå‰ç™»å½• npmï¼‰
```

---

## **7. å¸¸è§é—®é¢˜**

### **Q1: å¦‚ä½•è§£å†³å­é¡¹ç›®ä¹‹é—´çš„å¾ªç¯ä¾èµ–ï¼Ÿ**

- ä½¿ç”¨ `"peerDependencies"` æ›¿ä»£ç›´æ¥ä¾èµ–ã€‚
- é‡æ„ä»£ç ï¼Œæå–å…¬å…±é€»è¾‘åˆ°ç‹¬ç«‹åŒ…ã€‚

### **Q2: å¦‚ä½•é™åˆ¶æŸäº›ä¾èµ–åªèƒ½åœ¨æ ¹ç›®å½•å®‰è£…ï¼Ÿ**

åœ¨ `pnpm-workspace.yaml` ä¸­è®¾ç½®ï¼š

```yaml
neverBuiltDependencies:
  - fsevents # ç¦æ­¢æŸäº›ä¾èµ–å®‰è£…
```

### **Q3: å¦‚ä½•å…¼å®¹ `npm/yarn workspace` é¡¹ç›®è¿ç§»ï¼Ÿ**

- æ›¿æ¢ `workspace:` åè®®ä¸ºå…·ä½“ç‰ˆæœ¬å·ï¼ˆå¦‚ `"^1.0.0"`ï¼‰ã€‚
- ä½¿ç”¨ `pnpm import` ä» `yarn.lock` æˆ– `package-lock.json` ç”Ÿæˆ `pnpm-lock.yaml`ã€‚

---

## **æ€»ç»“**

| åŠŸèƒ½                 | å‘½ä»¤ç¤ºä¾‹                                   |
| -------------------- | ------------------------------------------ |
| **åˆå§‹åŒ– workspace** | `pnpm init` + `pnpm-workspace.yaml`        |
| **å®‰è£…ä¾èµ–**         | `pnpm add react --filter @my-monorepo/app` |
| **è¿è¡Œè„šæœ¬**         | `pnpm --filter @my-monorepo/app dev`       |
| **æ‰¹é‡æ“ä½œ**         | `pnpm -r run build`                        |
| **å‘å¸ƒåŒ…**           | `pnpm -r publish`                          |

pnpm workspace æ˜¯ **Monorepo çš„æœ€ä½³å®è·µ**ï¼Œé€‚åˆç®¡ç†å¤æ‚çš„å‰ç«¯/å…¨æ ˆé¡¹ç›®ï¼ˆå¦‚ Next.js + NestJS + å…±äº«åº“ï¼‰ã€‚ğŸš€
